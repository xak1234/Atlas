<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3I / ATLAS Brightness Tracker — Live</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; }
    body {
      margin: 0;
      padding: 24px;
      background: #08101a;
      color: #e6eef8;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      width: 100%;
    }
    .card {
      background: linear-gradient(180deg, #0f1b2a, #071023);
      border-radius: 12px;
      padding: 28px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 28px;
    }
    .header-left h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    .header-left .sub {
      color: #93aecd;
      font-size: 12px;
      margin-top: 4px;
    }
    .header-left .sub code {
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
    }
    .header-right {
      text-align: right;
    }
    .header-right > div {
      color: #93aecd;
      font-size: 12px;
      line-height: 1.6;
    }
    .status {
      color: #7ec8ff;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 24px;
    }

    .magnitude-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(126, 200, 255, 0.08);
      border-radius: 8px;
      border: 1px solid rgba(126, 200, 255, 0.15);
    }
    .big-mag {
      font-size: 64px;
      font-weight: 800;
      letter-spacing: -2px;
      line-height: 1;
    }
    .mag-source {
      font-size: 13px;
      color: #9fb3d2;
      margin-top: 8px;
      text-align: center;
    }
    .mag-status {
      font-size: 12px;
      font-weight: 600;
      margin-top: 6px;
      padding: 4px 10px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .mag-status.normal {
      background: rgba(126, 240, 163, 0.2);
      color: #7ef0a3;
    }
    .mag-status.abnormal {
      background: rgba(255, 155, 155, 0.2);
      color: #ff9b9b;
    }
    .mag-bar {
      width: 100%;
      height: 8px;
      background: #021827;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 12px;
    }
    .mag-bar > i {
      display: block;
      height: 100%;
      width: 0%;
      transition: width 0.6s linear;
      background: linear-gradient(90deg, #ffd166, #ff6b6b);
    }
    .mag-scale {
      width: 100%;
      display: flex;
      justify-content: space-between;
      color: #9fb3d2;
      font-size: 11px;
      margin-top: 6px;
    }

    .distance-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: rgba(126, 200, 255, 0.08);
      border-radius: 8px;
      border: 1px solid rgba(126, 200, 255, 0.15);
      margin-top: 12px;
    }
    .distance-label {
      font-size: 11px;
      color: #9fb3d2;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .distance-value {
      font-size: 24px;
      font-weight: 700;
      color: #ffd166;
      margin-top: 4px;
    }

    .starmap-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .contact-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(126, 200, 255, 0.08);
      border-radius: 8px;
      border: 1px solid rgba(126, 200, 255, 0.15);
    }
    .days-label {
      font-size: 11px;
      color: #9fb3d2;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .days-to-contact {
      font-size: 32px;
      font-weight: 700;
      color: #7ef0a3;
      margin-bottom: 12px;
      text-align: center;
    }
    .contact-canvas-container {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 0;
    }
    .contact-canvas-container canvas {
      max-width: 100%;
      height: auto;
    }
    .observations {
      display: flex;
      flex-direction: column;
    }
    .observations h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
    }
    .observations .sub {
      color: #9fb3d2;
      font-size: 12px;
      margin-bottom: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }
    th {
      font-weight: 600;
      color: #9fb3d2;
      background: rgba(255, 255, 255, 0.02);
    }
    .history-table {
      max-height: 320px;
      overflow-y: auto;
    }

    footer {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
      font-size: 11px;
      color: #86a6c5;
    }
    footer code {
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 6px;
      border-radius: 3px;
    }

    @media (max-width: 720px) {
      .content {
        grid-template-columns: 1fr;
      }
      body {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div class="header-left">
          <h1>3I / ATLAS Unknown - Tracking — Live</h1>
          <div class="sub">Automated — data from <b>TheSkyLive</b> and <b>COBS</b>. Server: <code>https://atlas-c4gn.onrender.com</code></div>
        </div>
        <div class="header-right">
          <div id="lastUpdated">Last update: —</div>
          <div id="status" class="status">Status: connecting…</div>
        </div>
      </header>

      <div class="content">
        <div class="magnitude-card">
          <div class="big-mag" id="currentMag">—</div>
          <div class="mag-source" id="magSource">—</div>
          <div class="mag-status" id="magStatus">—</div>
          <div class="mag-bar">
            <i id="magBar" style="width: 0%"></i>
          </div>
          <div class="mag-scale">
            <div>Bright (0)</div>
            <div>Faint (18+)</div>
          </div>
          <div class="distance-card">
            <div class="distance-label">Distance to Earth</div>
            <div class="distance-value" id="distanceValue">—</div>
            <div class="distance-label" style="margin-top: 4px;">km</div>
          </div>
        </div>

      <div class="starmap-section">
        <div class="contact-section">
          <div class="days-label">Days to Contact</div>
          <div class="days-to-contact" id="daysToContact">—</div>
          <div class="contact-canvas-container">
            <canvas id="contactCanvas" width="220" height="100"></canvas>
          </div>
        </div>
        <div class="contact-section">
          <div class="days-label">Distance Tracking</div>
          <div class="contact-canvas-container">
            <canvas id="trackingCanvas" width="220" height="200"></canvas>
          </div>
        </div>
      </div>

        <div class="observations">
          <h3>Observations (latest first)</h3>
          <div class="sub">Auto-refresh: every 6 hours</div>
          <div class="history-table">
            <table id="historyTable">
              <thead>
                <tr>
                  <th>Time (UTC)</th>
                  <th>Source</th>
                  <th>Mag</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <footer>
        Designed for Render deployment. Server: <code>https://atlas-c4gn.onrender.com</code>. Contact for customizations.
      </footer>
    </div>
  </div>

<script>
// Live client for atlas-c4gn.onrender.com
const API_ROOT = 'https://atlas-c4gn.onrender.com';
const CLIENT_POLL_SECONDS = 21600; // 6 hours
const DISTANCE_POLL_SECONDS = 60; // Check real distance every 60 seconds
const DISTANCE_DISPLAY_INTERVAL = 1000; // Update display every 1 second (interpolated)
const MAX_HISTORY = 100;
let pollTimer = null;
let distanceTimer = null;
let distanceDisplayTimer = null;
let history = [];

// Distance tracking for smooth interpolation
let distanceState = {
  lastRealDistance: null,
  lastRealDistanceTime: null,
  currentDisplayDistance: null,
  velocityKmPerSecond: 61, // km/s (positive = approaching Earth, ~221,000 km/h)
  trajectoryPoints: [] // Array of {time, distance} for graphing
};

function formatUTC(d) {
  return new Date(d).toISOString().replace('T', ' ').replace('Z', ' UTC');
}

async function safeFetchJson(url) {
  try {
    const resp = await fetch(url, { cache: 'no-store' });
    const ct = resp.headers.get('content-type') || '';
    if (!resp.ok) {
      const text = await resp.text();
      return { ok: false, status: resp.status, text };
    }
    if (ct.includes('application/json') || ct.includes('text/json')) {
      try {
        const json = await resp.json();
        return { ok: true, json };
      } catch (e) {
        const text = await resp.text();
        return { ok: false, error: 'json', text };
      }
    }
    const text = await resp.text();
    return { ok: true, text };
  } catch (e) {
    return { ok: false, error: e.toString() };
  }
}

function updateUIFromEntry(entry) {
  const magEl = document.getElementById('currentMag');
  const srcEl = document.getElementById('magSource');
  const statusEl = document.getElementById('magStatus');
  const bar = document.getElementById('magBar');

  magEl.textContent = entry.mag.toFixed(2);
  srcEl.textContent = entry.src + (entry.note ? ' — ' + entry.note : '');

  // Display magnitude status
  if (entry.magStatus) {
    statusEl.textContent = entry.magStatus.toUpperCase();
    statusEl.className = 'mag-status ' + entry.magStatus;
  } else {
    statusEl.textContent = '—';
    statusEl.className = 'mag-status';
  }

  const clamped = Math.max(0, Math.min(18, entry.mag));
  const pct = Math.round((18 - clamped) / 18 * 100);
  bar.style.width = pct + '%';
}

function drawContactVisualization(distanceKm) {
  const canvas = document.getElementById('contactCanvas');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Calculate days to contact based on ACTUAL velocity from distance tracking
  const SECONDS_PER_DAY = 86400;
  // Use the actual velocity from distanceState, or default to 8.1 km/s
  const actualVelocity = distanceState.velocityKmPerSecond || 8.1;
  const totalSeconds = (distanceKm || 0) / actualVelocity;
  const daysToContact = totalSeconds / SECONDS_PER_DAY;
  
  // Update the days display
  const daysEl = document.getElementById('daysToContact');
  if (daysToContact > 0 && isFinite(daysToContact)) {
    daysEl.textContent = daysToContact.toFixed(1).toLocaleString();
  } else {
    daysEl.textContent = '—';
  }
  
  // Draw visualization
  const centerY = canvas.height / 2;
  
  // Draw Earth (green circle on the right)
  ctx.fillStyle = '#7ef0a3';
  ctx.beginPath();
  ctx.arc(180, centerY, 18, 0, Math.PI * 2);
  ctx.fill();
  
  // Draw Earth outline
  ctx.strokeStyle = '#7ef0a3';
  ctx.lineWidth = 2;
  ctx.stroke();
  
  // Draw simple Earth details (continents)
  ctx.fillStyle = '#05a84a';
  ctx.beginPath();
  ctx.arc(185, centerY - 5, 4, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.arc(175, centerY + 6, 3, 0, Math.PI * 2);
  ctx.fill();
  
  // Draw spaceship (red triangle pointing right toward Earth)
  const shipX = 30;
  ctx.fillStyle = '#ff6b6b';
  ctx.beginPath();
  ctx.moveTo(shipX + 12, centerY); // point facing right
  ctx.lineTo(shipX - 8, centerY - 8);
  ctx.lineTo(shipX - 8, centerY + 8);
  ctx.closePath();
  ctx.fill();
  
  // Draw line from ship to Earth
  ctx.strokeStyle = 'rgba(255, 107, 107, 0.5)';
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 4]);
  ctx.beginPath();
  ctx.moveTo(shipX + 12, centerY);
  ctx.lineTo(180 - 18, centerY);
  ctx.stroke();
  ctx.setLineDash([]);
}

function drawTrackingVisualization(distanceKm) {
  const canvas = document.getElementById('trackingCanvas');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  
  // Background
  ctx.fillStyle = '#08101a';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Draw orbital path (arc from comet to Earth)
  ctx.strokeStyle = 'rgba(126, 200, 255, 0.2)';
  ctx.lineWidth = 2;
  ctx.setLineDash([5, 5]);
  ctx.beginPath();
  ctx.arc(centerX, centerY, 100, -Math.PI * 0.3, Math.PI * 0.3, false);
  ctx.stroke();
  ctx.setLineDash([]);
  
  // Calculate progress toward Earth (0 = start at 310M km, 1 = Earth at 0 km)
  const startDistance = 310000000; // ~310M km
  const endDistance = 269000000;   // ~269M km (closest approach)
  const progress = (startDistance - distanceKm) / (startDistance - endDistance);
  const clampedProgress = Math.max(0, Math.min(1, progress));
  
  // Calculate comet position on the arc
  const angle = -Math.PI * 0.3 + (Math.PI * 0.6) * clampedProgress;
  const cometRadius = 100 - clampedProgress * 70; // Moves closer to Earth
  const cometX = centerX + Math.cos(angle) * cometRadius;
  const cometY = centerY + Math.sin(angle) * cometRadius;
  
  // Draw Sun (yellow circle in upper left)
  ctx.fillStyle = '#FFB81C';
  ctx.shadowColor = 'rgba(255, 184, 28, 0.5)';
  ctx.shadowBlur = 20;
  ctx.beginPath();
  ctx.arc(centerX - 120, centerY - 80, 15, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowColor = 'transparent';
  ctx.fillStyle = '#9fb3d2';
  ctx.font = '11px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText('Sun', centerX - 120, centerY - 60);
  
  // Draw Earth (blue circle on the right)
  ctx.fillStyle = '#4A9EE8';
  ctx.shadowColor = 'rgba(74, 158, 232, 0.5)';
  ctx.shadowBlur = 15;
  ctx.beginPath();
  ctx.arc(centerX + 100, centerY, 12, 0, Math.PI * 2);
  ctx.fill();
  
  // Draw Earth details (continents)
  ctx.fillStyle = '#2E7D3F';
  ctx.beginPath();
  ctx.arc(centerX + 102, centerY - 4, 3, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.arc(centerX + 96, centerY + 3, 2.5, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowColor = 'transparent';
  
  ctx.fillStyle = '#9fb3d2';
  ctx.textAlign = 'center';
  ctx.fillText('Earth', centerX + 100, centerY + 28);
  
  // Draw comet (white/cyan glowing sphere with tail)
  ctx.fillStyle = '#7ef0a3';
  ctx.shadowColor = 'rgba(126, 240, 163, 0.6)';
  ctx.shadowBlur = 15;
  ctx.beginPath();
  ctx.arc(cometX, cometY, 8, 0, Math.PI * 2);
  ctx.fill();
  
  // Draw comet tail (pointing away from sun)
  const tailAngle = Math.atan2(cometY - (centerY - 80), cometX - (centerX - 120));
  const tailStartX = cometX + Math.cos(tailAngle) * 8;
  const tailStartY = cometY + Math.sin(tailAngle) * 8;
  const tailEndX = cometX + Math.cos(tailAngle) * 35;
  const tailEndY = cometY + Math.sin(tailAngle) * 35;
  
  ctx.strokeStyle = 'rgba(126, 240, 163, 0.4)';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(tailStartX, tailStartY);
  ctx.lineTo(tailEndX, tailEndY);
  ctx.stroke();
  ctx.shadowColor = 'transparent';
  
  // Draw dashed line from comet to Earth
  ctx.strokeStyle = 'rgba(255, 107, 107, 0.4)';
  ctx.lineWidth = 1;
  ctx.setLineDash([3, 3]);
  ctx.beginPath();
  ctx.moveTo(cometX, cometY);
  ctx.lineTo(centerX + 100, centerY);
  ctx.stroke();
  ctx.setLineDash([]);
  
  // Draw distance label
  ctx.fillStyle = '#ffd166';
  ctx.font = 'bold 12px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText(distanceKm.toLocaleString('en-US', { maximumFractionDigits: 0 }) + ' km', centerX, 30);
  
  // Draw "sky movement" label
  ctx.fillStyle = '#9fb3d2';
  ctx.font = '10px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText('orbital trajectory', centerX, canvas.height - 15);
}

function renderHistoryTable() {
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';
  for (let row of history.slice(0, MAX_HISTORY)) {
    const tr = document.createElement('tr');
    const dt = `<td>${formatUTC(row.time)}</td>`;
    const src = `<td>${row.src}</td>`;
    const mag = `<td>${row.mag.toFixed(2)}</td>`;
    const note = `<td>${row.note || ''}</td>`;
    tr.innerHTML = dt + src + mag + note;
    tbody.appendChild(tr);
  }
}

async function fetchDistance() {
  try {
    const res = await safeFetchJson(API_ROOT + '/api/distance');
    if (res.ok && res.json && res.json.distanceKm !== null) {
      const newDistance = res.json.distanceKm;
      const now = Date.now();
      
      // Add to trajectory points for graphing
      distanceState.trajectoryPoints.push({ time: now, distance: newDistance });
      
      // Keep only last 2 hours of data (120 minutes)
      const twoHoursMs = 2 * 60 * 60 * 1000;
      distanceState.trajectoryPoints = distanceState.trajectoryPoints.filter(
        point => now - point.time < twoHoursMs
      );
      
      // Calculate velocity if we have a previous reading
      if (distanceState.lastRealDistance !== null && distanceState.lastRealDistanceTime !== null) {
        const timeDiffSeconds = (now - distanceState.lastRealDistanceTime) / 1000;
        const distanceDiffKm = distanceState.lastRealDistance - newDistance; // Positive if approaching
        if (timeDiffSeconds > 0) {
          distanceState.velocityKmPerSecond = distanceDiffKm / timeDiffSeconds;
          console.log(`Distance updated: ${newDistance.toLocaleString()} km | Velocity: ${distanceState.velocityKmPerSecond.toFixed(2)} km/s | Time since last fetch: ${timeDiffSeconds.toFixed(1)}s`);
        }
      } else {
        console.log(`Initial distance: ${newDistance.toLocaleString()} km`);
      }
      
      // Update the state with new real distance
      distanceState.lastRealDistance = newDistance;
      distanceState.lastRealDistanceTime = now;
      distanceState.currentDisplayDistance = newDistance;
      
      // Update display immediately with the new real distance
      updateDistanceDisplay(newDistance);
    }
  } catch (e) {
    console.error('Distance fetch failed:', e);
  }
}

function updateDistanceDisplay(distanceKm) {
  const distEl = document.getElementById('distanceValue');
  distEl.textContent = distanceKm.toLocaleString('en-US', { maximumFractionDigits: 0 });
  // Update the visualizations with the new distance
  drawContactVisualization(distanceKm);
  drawTrackingVisualization(distanceKm);
}

function interpolateDistance() {
  if (distanceState.lastRealDistanceTime === null) {
    return;
  }
  
  const now = Date.now();
  const timeSinceLastFetchSeconds = (now - distanceState.lastRealDistanceTime) / 1000;
  
  // Calculate interpolated distance based on velocity
  const distanceChange = distanceState.velocityKmPerSecond * timeSinceLastFetchSeconds;
  const interpolatedDistance = distanceState.lastRealDistance - distanceChange;
  
  // Update display with interpolated value
  distanceState.currentDisplayDistance = interpolatedDistance;
  updateDistanceDisplay(interpolatedDistance);
}

async function fetchLatest() {
  document.getElementById('status').textContent = 'Status: fetching…';
  try {
    const res = await safeFetchJson(API_ROOT + '/api/latest');
    if (!res.ok) {
      document.getElementById('status').textContent = 'Status: fetch failed';
      return;
    }
    const cache = res.json.cache || res.json;
    let mag = cache.latestMag ?? cache.observedMag ?? cache.predictedMag ?? null;
    let src = cache.source ?? 'unknown';
    let magStatus = cache.magStatus ?? 'normal';

    if (mag === null) {
      document.getElementById('status').textContent = 'Status: no data';
      return;
    }

    const entry = {
      time: new Date(),
      src,
      mag: Number(mag),
      magStatus,
      note: ''
    };

    // add to history if new
    if (!history.length || history[0].mag !== entry.mag) {
      history.unshift(entry);
      if (history.length > MAX_HISTORY) history.pop();
    }

    renderHistoryTable();
    updateUIFromEntry(entry);

    renderHistoryTable();
    updateUIFromEntry(entry);

    document.getElementById('lastUpdated').textContent = 'Last update: ' + formatUTC(new Date(cache.updated || Date.now()));
    document.getElementById('status').textContent = 'Status: OK';
  } catch (e) {
    document.getElementById('status').textContent = 'Status: error';
    console.error(e);
  }
}

// start automatic polling
(async function() {
  // immediate fetch on page load
  await fetchLatest();
  await fetchDistance();
  // then schedule for magnitude (every 6 hours) and distance (every 60 seconds for real data)
  pollTimer = setInterval(fetchLatest, CLIENT_POLL_SECONDS * 1000);
  distanceTimer = setInterval(fetchDistance, DISTANCE_POLL_SECONDS * 1000);
  // Interpolate distance display every second
  distanceDisplayTimer = setInterval(interpolateDistance, DISTANCE_DISPLAY_INTERVAL);
})();
</script>
</body>
</html>
