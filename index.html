<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3I / ATLAS Brightness Tracker — Live</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; }
    body {
      margin: 0;
      padding: 24px;
      background: #08101a;
      color: #e6eef8;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      width: 100%;
    }
    .card {
      background: linear-gradient(180deg, #0f1b2a, #071023);
      border-radius: 12px;
      padding: 28px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 28px;
    }
    .header-left h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    .header-left .sub {
      color: #93aecd;
      font-size: 12px;
      margin-top: 4px;
    }
    .header-left .sub code {
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
    }
    .header-right {
      text-align: right;
    }
    .header-right > div {
      color: #93aecd;
      font-size: 12px;
      line-height: 1.6;
    }
    .status {
      color: #7ec8ff;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 24px;
    }

    .magnitude-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(126, 200, 255, 0.08);
      border-radius: 8px;
      border: 1px solid rgba(126, 200, 255, 0.15);
    }
    .big-mag {
      font-size: 64px;
      font-weight: 800;
      letter-spacing: -2px;
      line-height: 1;
    }
    .mag-source {
      font-size: 13px;
      color: #9fb3d2;
      margin-top: 8px;
      text-align: center;
    }
    .mag-bar {
      width: 100%;
      height: 8px;
      background: #021827;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 12px;
    }
    .mag-bar > i {
      display: block;
      height: 100%;
      width: 0%;
      transition: width 0.6s linear;
      background: linear-gradient(90deg, #ffd166, #ff6b6b);
    }
    .mag-scale {
      width: 100%;
      display: flex;
      justify-content: space-between;
      color: #9fb3d2;
      font-size: 11px;
      margin-top: 6px;
    }

    .distance-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: rgba(126, 200, 255, 0.08);
      border-radius: 8px;
      border: 1px solid rgba(126, 200, 255, 0.15);
      margin-top: 12px;
    }
    .distance-label {
      font-size: 11px;
      color: #9fb3d2;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .distance-value {
      font-size: 24px;
      font-weight: 700;
      color: #ffd166;
      margin-top: 4px;
    }

    .observations {
      display: flex;
      flex-direction: column;
    }
    .observations h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
    }
    .observations .sub {
      color: #9fb3d2;
      font-size: 12px;
      margin-bottom: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }
    th {
      font-weight: 600;
      color: #9fb3d2;
      background: rgba(255, 255, 255, 0.02);
    }
    .history-table {
      max-height: 320px;
      overflow-y: auto;
    }

    footer {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
      font-size: 11px;
      color: #86a6c5;
    }
    footer code {
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 6px;
      border-radius: 3px;
    }

    @media (max-width: 720px) {
      .content {
        grid-template-columns: 1fr;
      }
      body {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div class="header-left">
          <h1>3I / ATLAS Brightness Tracker — Live</h1>
          <div class="sub">Automated — data from <b>TheSkyLive</b> and <b>COBS</b>. Server: <code>https://atlas-c4gn.onrender.com</code></div>
        </div>
        <div class="header-right">
          <div id="lastUpdated">Last update: —</div>
          <div id="status" class="status">Status: connecting…</div>
        </div>
      </header>

      <div class="content">
        <div class="magnitude-card">
          <div class="big-mag" id="currentMag">—</div>
          <div class="mag-source" id="magSource">—</div>
          <div class="mag-bar">
            <i id="magBar" style="width: 0%"></i>
          </div>
          <div class="mag-scale">
            <div>Bright (0)</div>
            <div>Faint (18+)</div>
          </div>
          <div class="distance-card">
            <div class="distance-label">Distance to Earth</div>
            <div class="distance-value" id="distanceValue">—</div>
            <div class="distance-label" style="margin-top: 4px;">km</div>
          </div>
        </div>

        <div class="observations">
          <h3>Observations (latest first)</h3>
          <div class="sub">Auto-refresh: every 6 hours</div>
          <div class="history-table">
            <table id="historyTable">
              <thead>
                <tr>
                  <th>Time (UTC)</th>
                  <th>Source</th>
                  <th>Mag</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <footer>
        Designed for Render deployment. Server: <code>https://atlas-c4gn.onrender.com</code>. Contact for customizations.
      </footer>
    </div>
  </div>

<script>
// Live client for atlas-c4gn.onrender.com
const API_ROOT = 'https://atlas-c4gn.onrender.com';
const CLIENT_POLL_SECONDS = 21600; // 6 hours
const DISTANCE_POLL_SECONDS = 10; // 10 seconds
const MAX_HISTORY = 100;
let pollTimer = null;
let distanceTimer = null;
let history = [];

function formatUTC(d) {
  return new Date(d).toISOString().replace('T', ' ').replace('Z', ' UTC');
}

async function safeFetchJson(url) {
  try {
    const resp = await fetch(url, { cache: 'no-store' });
    const ct = resp.headers.get('content-type') || '';
    if (!resp.ok) {
      const text = await resp.text();
      return { ok: false, status: resp.status, text };
    }
    if (ct.includes('application/json') || ct.includes('text/json')) {
      try {
        const json = await resp.json();
        return { ok: true, json };
      } catch (e) {
        const text = await resp.text();
        return { ok: false, error: 'json', text };
      }
    }
    const text = await resp.text();
    return { ok: true, text };
  } catch (e) {
    return { ok: false, error: e.toString() };
  }
}

function updateUIFromEntry(entry) {
  const magEl = document.getElementById('currentMag');
  const srcEl = document.getElementById('magSource');
  const bar = document.getElementById('magBar');

  magEl.textContent = entry.mag.toFixed(2);
  srcEl.textContent = entry.src + (entry.note ? ' — ' + entry.note : '');

  const clamped = Math.max(0, Math.min(18, entry.mag));
  const pct = Math.round((18 - clamped) / 18 * 100);
  bar.style.width = pct + '%';
}

function renderHistoryTable() {
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';
  for (let row of history.slice(0, MAX_HISTORY)) {
    const tr = document.createElement('tr');
    const dt = `<td>${formatUTC(row.time)}</td>`;
    const src = `<td>${row.src}</td>`;
    const mag = `<td>${row.mag.toFixed(2)}</td>`;
    const note = `<td>${row.note || ''}</td>`;
    tr.innerHTML = dt + src + mag + note;
    tbody.appendChild(tr);
  }
}

async function fetchDistance() {
  try {
    const res = await safeFetchJson(API_ROOT + '/api/distance');
    if (res.ok && res.json && res.json.distanceKm !== null) {
      const distEl = document.getElementById('distanceValue');
      const km = res.json.distanceKm;
      distEl.textContent = km.toLocaleString('en-US', { maximumFractionDigits: 0 });
    }
  } catch (e) {
    console.error('Distance fetch failed:', e);
  }
}

async function fetchLatest() {
  document.getElementById('status').textContent = 'Status: fetching…';
  try {
    const res = await safeFetchJson(API_ROOT + '/api/latest');
    if (!res.ok) {
      document.getElementById('status').textContent = 'Status: fetch failed';
      return;
    }
    const cache = res.json.cache || res.json;
    let mag = cache.latestMag ?? cache.observedMag ?? cache.predictedMag ?? null;
    let src = cache.source ?? 'unknown';

    if (mag === null) {
      document.getElementById('status').textContent = 'Status: no data';
      return;
    }

    const entry = {
      time: new Date(),
      src,
      mag: Number(mag),
      note: ''
    };

    // add to history if new
    if (!history.length || history[0].mag !== entry.mag) {
      history.unshift(entry);
      if (history.length > MAX_HISTORY) history.pop();
    }

    renderHistoryTable();
    updateUIFromEntry(entry);

    document.getElementById('lastUpdated').textContent = 'Last update: ' + formatUTC(new Date(cache.updated || Date.now()));
    document.getElementById('status').textContent = 'Status: OK';
  } catch (e) {
    document.getElementById('status').textContent = 'Status: error';
    console.error(e);
  }
}

// start automatic polling
(async function() {
  // immediate fetch on page load
  await fetchLatest();
  await fetchDistance();
  // then schedule for magnitude (every 6 hours) and distance (every 10 seconds)
  pollTimer = setInterval(fetchLatest, CLIENT_POLL_SECONDS * 1000);
  distanceTimer = setInterval(fetchDistance, DISTANCE_POLL_SECONDS * 1000);
})();
</script>
</body>
</html>
